<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Trust Law Textbooks — Search (beta)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f2f46; --ink:#0b1f2c; --muted:#6a7a86; --card:#fff; --ring:#e7edf2;
      --chip:#eef3f6; --chip-t:#0f2f46; --maxw:1024px; --r:12px;
      --shadow:0 1px 2px rgba(10,22,34,.06),0 4px 14px rgba(10,22,34,.07)
    }
    *{box-sizing:border-box}
    html,body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    a{color:inherit;text-decoration:none}
    header{background:var(--bg);color:#fff}
    .bar{max-width:var(--maxw);margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand img{height:28px;width:auto;display:block}
    .brand small{opacity:.8;font-weight:500}
    main{max-width:var(--maxw);margin:18px auto 64px;padding:0 16px}
    .crumb{font-size:.9rem;color:var(--muted);margin-bottom:10px}
    h1{font-size:1.2rem;margin:0 0 10px}
    .row{display:flex;gap:10px;margin:10px 0 16px}
    input[type="search"]{flex:1;padding:12px 14px;border:1px solid var(--ring);border-radius:10px;font-size:1rem}
    button{padding:12px 16px;border:0;border-radius:10px;background:#1779c6;color:#fff;font-weight:600;cursor:pointer}
    .hint{font-size:.9rem;color:var(--muted)}
    .group{margin:18px 0}
    .group h2{font-size:1rem;margin:0 0 10px;color:var(--muted)}
    .card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;margin-bottom:12px;border:1px solid var(--ring)}
    .title{font-weight:700;margin-bottom:6px}
    .meta{font-size:.85rem;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .chip{background:var(--chip);color:var(--chip-t);font-size:.75rem;padding:3px 8px;border-radius:999px}
    .snippet{line-height:1.45}
    mark{background:#ffe58f;padding:0 .1em}
    .rightlink{font-size:.85rem}
    .counts{font-size:.9rem;color:var(--muted);margin:6px 0 0}
    .err{color:#b40028}
    .topnav{margin-left:auto}
    .topnav a{color:#cfe7f7;font-size:.95rem}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <a class="brand" href="./index.html">
        <!-- YOUR LOGO -->
        <img src="./logo.png" alt="BCB" />
        <span>Trust Law Textbooks</span>
        <small>Search (beta)</small>
      </a>
      <div class="topnav"><a href="./index.html">Catalog</a></div>
    </div>
  </header>

  <main>
    <div class="crumb"><a href="./index.html">Catalog</a> / Search (beta)</div>
    <h1>Trust Law Textbooks — Search (beta)</h1>

    <form class="row" id="qform">
      <input id="q" type="search" placeholder="Search textbooks + laws + rules… e.g., Beddoe, beneficiaries’ consent, litigation costs" autocomplete="on" />
      <button type="submit">Search</button>
    </form>
    <div class="hint">Searches: <b>Textbooks</b> (public catalog) + <b>Laws</b> (laws-ui) + <b>Rules</b> (rules-ui). Results show quotable snippets; click the title to open the full TXT.</div>

    <div id="counts" class="counts"></div>
    <div id="results"></div>
  </main>

  <script>
  // ---------- CONFIG: public catalogs ----------
  const SOURCES = [
    {
      name: "Textbooks",
      kind: "textbooks",
      base: "https://info1691.github.io/law-index/",
      catalog: "catalogs/ingest-catalog.json"
    },
    {
      name: "Laws",
      kind: "laws",
      base: "https://info1691.github.io/laws-ui/",
      catalog: "laws.json"
    },
    {
      name: "Rules",
      kind: "rules",
      base: "https://info1691.github.io/rules-ui/",
      catalog: "rules.json"
    }
  ];

  // Utility
  const byId = (id)=>document.getElementById(id);
  const toAbs = (base, url) => new URL(url, base).href;

  function parseTerms(q){
    return q.toLowerCase().trim().split(/\s+/).filter(Boolean);
  }
  function firstMatchIndex(hay, terms){
    hay = hay.toLowerCase();
    let idx = -1;
    for(const t of terms){
      const i = hay.indexOf(t);
      if(i !== -1 && (idx === -1 || i < idx)) idx = i;
    }
    return idx;
  }
  function makeSnippet(txt, idx, span=160){
    const start = Math.max(0, idx - Math.floor(span/2));
    const end = Math.min(txt.length, start + span);
    return (start>0?"…":"") + txt.slice(start, end) + (end<txt.length?"…":"");
  }
  function highlight(snippet, terms){
    let out = snippet;
    // simple, safe highlight (small queries)
    terms.forEach(t=>{
      const re = new RegExp("(" + t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + ")", "gi");
      out = out.replace(re,"<mark>$1</mark>");
    });
    return out;
  }

  async function fetchJSON(url){
    const r = await fetch(url, {mode:"cors"});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }
  async function fetchText(url){
    const r = await fetch(url, {mode:"cors"});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.text();
  }

  function renderGroupHeader(name){ 
    const g = document.createElement("div"); g.className="group";
    const h = document.createElement("h2"); h.textContent = name;
    g.appendChild(h);
    return g;
  }
  function renderCard(item, snippetHTML, absTxt, sourceLabel){
    const card = document.createElement("div"); card.className="card";
    const t = document.createElement("div"); t.className="title";
    const a = document.createElement("a"); a.href = absTxt; a.textContent = item.title || item.reference || item.id;
    a.target = "_blank"; a.rel="noopener";
    t.appendChild(a);
    const meta = document.createElement("div"); meta.className="meta";
    if(item.jurisdiction) meta.append(item.jurisdiction.toUpperCase());
    if(item.year) meta.append("· " + item.year);
    const chip = document.createElement("span"); chip.className="chip"; chip.textContent = sourceLabel;
    meta.append(chip);
    const sn = document.createElement("div"); sn.className="snippet"; sn.innerHTML = snippetHTML;
    const rl = document.createElement("div"); rl.className="rightlink";
    const open = document.createElement("a"); open.href = absTxt; open.target="_blank"; open.rel="noopener"; open.textContent = "open TXT";
    rl.append("¶ ", open);
    card.append(t, meta, sn, rl);
    return card;
  }

  async function runSearch(q){
    const resultsEl = byId("results"); resultsEl.innerHTML="";
    const countsEl = byId("counts");
    const terms = parseTerms(q);
    if(terms.length === 0){ countsEl.textContent = ""; return; }

    let totals = {Textbooks:0, Laws:0, Rules:0};
    for (const src of SOURCES){
      const group = renderGroupHeader(src.name);
      resultsEl.appendChild(group);

      let list;
      try {
        const catalogUrl = toAbs(src.base, src.catalog);
        list = await fetchJSON(catalogUrl);
      } catch (e){
        const err = document.createElement("div");
        err.className="err";
        err.textContent = `Failed to load ${src.name} catalog.`;
        group.appendChild(err);
        continue;
      }

      // Defensive: catalogs may be arrays or {items:[]}
      const items = Array.isArray(list) ? list : (list.items || []);
      // Search each item by fetching its TXT (lightweight snippet scan).
      for (const item of items){
        const absTxt = toAbs(src.base, item.url_txt || item.url || "");
        if(!absTxt) continue;
        try{
          const txt = await fetchText(absTxt);
          const idx = firstMatchIndex(txt, terms);
          if(idx === -1) continue;
          const snippet = makeSnippet(txt, idx, 220);
          const snippetHTML = highlight(snippet, terms);
          group.appendChild(renderCard(item, snippetHTML, absTxt, src.name.toLowerCase()));
          totals[src.name] += 1;
        }catch(e){
          // ignore fetch failures of individual docs
        }
      }
      if(totals[src.name] === 0){
        const none = document.createElement("div");
        none.className="card"; none.style.color="var(--muted)";
        none.textContent = "No matches.";
        group.appendChild(none);
      }
    }

    countsEl.textContent = `Loaded → Textbooks: ${totals.Textbooks} · Laws: ${totals.Laws} · Rules: ${totals.Rules}`;
  }

  // Wire up
  const form = document.getElementById("qform");
  const input = document.getElementById("q");
  form.addEventListener("submit",(e)=>{
    e.preventDefault(); // IMPORTANT: keep SPA behaviour
    runSearch(input.value);
  });

  // If a ?q= param exists, preload it
  const params = new URLSearchParams(location.search);
  const q0 = params.get("q");
  if(q0){ input.value = q0; runSearch(q0); }

  </script>
</body>
</html>
