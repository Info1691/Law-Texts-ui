<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Search (beta) — Trust Law Textbooks</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#0f172a;}
    header{background:#0b2e47;color:#fff;padding:14px 18px;display:flex;gap:12px;align-items:center}
    header a{color:#fff;text-decoration:none;opacity:.9}
    main{max-width:980px;margin:24px auto;padding:0 16px}
    .panel{background:#fff;border-radius:10px;padding:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="search"]{flex:1;min-width:240px;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:16px}
    .count{font-size:.9rem;opacity:.75}
    ul{list-style:none;margin:16px 0 0;padding:0}
    li{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:14px 16px;margin:12px 0}
    .title{font-weight:700;margin:0 0 6px 0}
    .meta{font-size:.9rem;opacity:.8;margin-bottom:8px}
    .chip{display:inline-block;font-size:.75rem;border-radius:999px;padding:4px 9px;border:1px solid #d1d5db;background:#fff;margin-right:8px;text-decoration:none;color:#111}
    .muted{opacity:.7}
    .note{font-size:.9rem;opacity:.8;margin-top:10px}
  </style>
</head>
<body>
  <header>
    <a href="./">&larr; Back</a>
    <strong>Search (beta)</strong>
  </header>

  <main>
    <div class="panel">
      <div class="row">
        <input id="q" type="search" placeholder="Search title / reference / jurisdiction …" autofocus />
        <span class="count" id="count">0 results</span>
      </div>
      <ul id="results" aria-live="polite"></ul>
      <p class="note muted">
        Data source: <code>law-index/catalogs/ingest-catalog.json</code>. TXT links open in the public <em>law-index</em> repo.
      </p>
    </div>
  </main>

  <script>
    const DATA_URL = 'https://info1691.github.io/law-index/catalogs/ingest-catalog.json';
    const $q = document.getElementById('q');
    const $list = document.getElementById('results');
    const $count = document.getElementById('count');

    const norm = v => (v ?? '').toString().toLowerCase();
    const tokens = s => norm(s).split(/\s+/).filter(Boolean);

    let items = [];

    function render(rows){
      $list.innerHTML = '';
      rows.forEach(item => {
        const li = document.createElement('li');

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = item.title || item.reference || item.slug || 'Untitled';

        const meta = document.createElement('div');
        meta.className = 'meta';
        const bits = [];
        if (item.jurisdiction) bits.push(item.jurisdiction.toUpperCase());
        if (item.year) bits.push(item.year);
        if (item.reference) bits.push(item.reference);
        meta.textContent = bits.join(' · ');

        const actions = document.createElement('div');
        const txtPath = item.txt ? String(item.txt).replace(/^\.?\/*/, '') : '';
        if (txtPath) {
          const a = document.createElement('a');
          a.className = 'chip';
          a.textContent = 'TXT';
          a.href = `https://info1691.github.io/law-index/${txtPath}`;
          a.target = '_blank';
          a.rel = 'noopener';
          actions.appendChild(a);
        }
        li.append(title, meta, actions);
        $list.appendChild(li);
      });
      $count.textContent = `${rows.length} result${rows.length===1?'':'s'}`;
    }

    function search(){
      const q = tokens($q.value);
      if (!q.length) { render(items); return; }
      const out = items.filter(it => {
        const hay = [
          it.title, it.reference, it.jurisdiction, it.year, it.slug
        ].map(norm).join(' ');
        return q.every(t => hay.includes(t));
      });
      render(out);
    }

    (async () => {
      try {
        const res = await fetch(DATA_URL, {cache:'no-cache'});
        const data = await res.json();
        items = Array.isArray(data) ? data : (data.items || []);
        render(items);
      } catch (e) {
        $list.innerHTML = `<li>Failed to load catalog. Please try again.</li>`;
        $count.textContent = '0 results';
      }
    })();

    $q.addEventListener('input', search);
  </script>
</body>
</html>
