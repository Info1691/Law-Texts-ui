<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Agent 3 — Trust Law (BM25 index)</title>
<link rel="stylesheet" href="app.css"/>
<link rel="stylesheet" href="brand.css"/>
<style>
:root { --card-bg: #0e1522; --ink:#e9eef7; --muted:#9fb3d1; }
body { background:#0b1220; color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
.wrap { max-width: 1000px; margin: 24px auto; padding: 0 12px; }
.row { display:flex; gap:8px; align-items:center; }
input[type=text]{ flex:1; background:#0e1522; border:1px solid #19314f; color:var(--ink); padding:10px 12px; border-radius:8px; }
button{ background:#2a6df2; border:0; color:white; padding:10px 14px; border-radius:8px; cursor:pointer; }
.note{ font-size:12px; color:var(--muted); margin:8px 0 18px; }
.card{ background:var(--card-bg); border:1px solid #142036; border-radius:10px; padding:14px 16px; margin:12px 0; }
.badge{ background:#213756; color:#b8cff5; padding:2px 8px; border-radius:999px; font-size:12px; }
small a{ color:#9ec1ff; }
mark{ background:#f0c36a3d; padding:0 2px; border-radius:2px; }
#diag{ font-size:12px; color:var(--muted); }
</style>
</head>
<body>
<div class="wrap">
  <h2>Agent 3 — Trust Law <small class="badge">(BM25/Lunr)</small></h2>
  <div class="row" style="margin:10px 0 6px">
    <input id="q" type="text" placeholder='e.g., "beddoe consent" litigation'/>
    <label style="display:flex;gap:6px;align-items:center;color:var(--muted);font-size:12px">
      <input id="orMode" type="checkbox"/> OR mode
    </label>
    <button id="go">Search</button>
  </div>
  <div class="note">Searches all TXT listed in the catalogs on <b>texts.wwwbcb.org</b>. Results are chunk-level BM25/Lunr matches with source links. No model inference; no hallucinations.</div>

  <div id="results" class="card">Index loading…</div>
  <div id="diag" class="card" style="display:none"></div>
</div>

<script>
const A3_BASE = location.origin + '/agent3-bm25/';
const META_URL  = A3_BASE + 'agent3.meta.json';
const INDEX_URL = A3_BASE + 'lunr-index.json';
const CHUNKS_URL= A3_BASE + 'chunks.jsonl';

let idx = null, chunks = null, meta = null;

async function boot(){
  try{
    const [m,i,c] = await Promise.all([
      fetch(META_URL).then(r=>r.json()),
      fetch(INDEX_URL).then(r=>r.json()),
      fetch(CHUNKS_URL).then(r=>r.text())
    ]);
    meta = m;
    idx = lunr.Index.load(i);
    chunks = c.trim().split('\n').map(x=>JSON.parse(x));
    const r = document.getElementById('results');
    if(meta.catalogItems===0 || chunks.length===0){
      r.textContent = 'Index empty — catalogs yielded no items. Check agent3-bm25 build.';
    }else{
      r.textContent = `Ready. Catalog items: ${meta.catalogItems} • Docs: ${meta.docs} • Chunks: ${meta.chunkCount}`;
    }
    const d = document.getElementById('diag');
    d.style.display = 'block';
    d.textContent = JSON.stringify({meta, loadedChunks: chunks.length}, null, 2);
  }catch(e){
    document.getElementById('results').textContent = 'Failed to load index: ' + e;
  }
}
document.getElementById('go').onclick = run;
document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') run(); });

function run(){
  const r = document.getElementById('results');
  const q = document.getElementById('q').value.trim();
  const orMode = document.getElementById('orMode').checked;
  if(!idx || !chunks){ r.textContent = 'Index not ready.'; return; }
  if(!q){ r.textContent = 'Enter a query.'; return; }

  const terms = q.replace(/"/g,'').split(/\s+/).filter(Boolean);
  const lunrQuery = terms.map(t => (orMode? t : '+'+t)).join(' ');

  let hits = [];
  try{
    hits = idx.search(lunrQuery);
  }catch(e){
    r.textContent = 'Query parse error: ' + e;
    return;
  }

  if(!hits.length){ r.textContent = 'No matches.'; return; }

  const out = hits.slice(0,20).map(h=>{
    const c = chunks.find(x=>x.id===h.ref) || { text:'[missing chunk]' };
    const snippet = c.text.length>500 ? c.text.slice(0,500)+'…' : c.text;
    const src = c.url || '';
    return `<div class="card">
      <div style="margin-bottom:6px"><span class="badge">${c.kind||''}</span> ${c.title||''} <small>— ${c.jurisdiction||''}</small></div>
      <div>${snippet.replace(new RegExp(terms.map(x=>x.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')).join('|'),'gi'), m=>`<mark>${m}</mark>`)}</div>
      <div style="margin-top:8px"><small><a href="${src}" target="_blank" rel="noopener">open TXT</a></small></div>
    </div>`;
  }).join('');
  r.innerHTML = out;
}
</script>
<script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script>
</body>
</html>
