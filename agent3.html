<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Agent 3 — Trust Law (BM25 index)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" href="/logo.png"/>
  <link rel="preconnect" href="https://unpkg.com"/>
  <script src="https://unpkg.com/lunr/lunr.js"></script>
  <style>
    :root{--bg:#0b1220;--panel:#121a2b;--muted:#8aa1c1;--fg:#eaf2ff;--accent:#2f6feb;}
    html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    header{display:flex;align-items:center;gap:.75rem;padding:14px 18px;border-bottom:1px solid #22314d;background:#0d1526;}
    header .brand{font-weight:700;letter-spacing:.2px}
    main{max-width:1080px;margin:0 auto;padding:18px}
    .row{display:flex;gap:.5rem;align-items:center}
    input[type="text"]{flex:1;background:#0e1728;border:1px solid #23324f;border-radius:8px;color:var(--fg);padding:12px 14px}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
    label{color:var(--muted);font-size:.9rem}
    .note{color:var(--muted);margin:10px 2px}
    .card{background:var(--panel);border:1px solid #22314d;border-radius:12px;padding:14px 16px;margin:12px 0}
    .title{font-weight:700;margin-bottom:6px}
    .meta{color:var(--muted);font-size:.9rem;margin-bottom:10px}
    .hitmark{background:#3a76ff33;border:1px solid #3a76ff55;border-radius:6px;padding:6px 8px;display:inline-block;margin:6px 0}
    a{color:#99c0ff;text-decoration:none}
    .diag{margin-top:18px;color:#7f97b7;font-size:.85rem}
    mark{background:#444;color:#fff;border-radius:4px;padding:0 3px}
  </style>
</head>
<body>
  <header>
    <img src="/logo.png" alt="" width="22" height="22"/>
    <div class="brand">Agent 3 — Trust Law</div>
    <div style="margin-left:auto;color:#7fa7ff;font-size:.9rem">(BM25/Lunr — no LLM; no hallucinations)</div>
  </header>

  <main>
    <div class="row">
      <input id="q" type="text" placeholder="e.g., beddoe consent, Saunders v Vautier, trustee proper law">
      <label><input id="or" type="checkbox"> OR mode</label>
      <button id="go" class="btn">Search</button>
    </div>
    <div class="note">Searches all TXT listed in the catalogs on <code>texts.wwwbcb.org</code>. Results are chunk-level matches with source links.</div>

    <div id="results" class="card">Index loading…</div>
    <div id="diag" class="diag"></div>
  </main>

  <script>
  (async function(){
    const RESULTS = document.getElementById('results');
    const DIAG = document.getElementById('diag');
    const OR = document.getElementById('or');
    const Q = document.getElementById('q');
    const GO = document.getElementById('go');

    // Where the index files live:
    const BASE = "/agent3-bm25";
    const INDEX_URL  = BASE + "/lunr-index.json";
    const CHUNKS_URL = BASE + "/chunks.jsonl";

    // Load index & chunk metadata
    let lunrIndex, chunksMap = new Map(), total = 0, firstReady = false;

    function htmlEscape(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function* parseJSONL(text){
      const lines = text.split(/\r?\n/);
      for (const line of lines) {
        if (!line.trim()) continue;
        yield JSON.parse(line);
      }
    }

    async function load() {
      RESULTS.textContent = "Index loading…";
      const [idxJson, chunksText] = await Promise.all([
        fetch(INDEX_URL).then(r => r.json()),
        fetch(CHUNKS_URL).then(r => r.text()),
      ]);
      lunrIndex = lunr.Index.load(idxJson);
      let n = 0;
      for (const obj of parseJSONL(chunksText)) {
        chunksMap.set(String(obj.id), obj);
        n++;
      }
      total = n;
      RESULTS.textContent = "Ready. Enter a query.";
      DIAG.textContent = `Loaded chunks: ${total}`;
      firstReady = true;
    }

    function makeOrQuery(q) {
      // Convert bare "a b c" to "(a) OR (b) OR (c)" while leaving quotes alone
      // Simple token split that respects double quotes
      const tokens = [];
      q.replace(/"([^"]+)"|(\S+)/g, (_, quoted, bare) => tokens.push(quoted ? `"${quoted}"` : bare));
      return tokens.length > 1 ? tokens.map(t => `(${t})`).join(" OR ") : q;
    }

    function highlight(text, query) {
      const terms = [];
      query.replace(/"([^"]+)"|(\S+)/g, (_, quoted, bare) => terms.push(quoted || bare));
      let out = htmlEscape(text);
      for (const t of terms) {
        if (!t) continue;
        const re = new RegExp("(" + t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + ")", "gi");
        out = out.replace(re, "<mark>$1</mark>");
      }
      return out;
    }

    function render(results, query) {
      if (!results.length) {
        RESULTS.innerHTML = '<div class="card">No matches.</div>';
        return;
      }
      const parts = [];
      for (const r of results.slice(0, 50)) {
        const c = chunksMap.get(String(r.ref));
        if (!c) continue;
        const snippet = c.text.length > 700 ? c.text.slice(0, 700) + "…" : c.text;
        parts.push(`
          <div class="card">
            <div class="title">${htmlEscape(c.title)} <span class="meta">· ${htmlEscape(c.kind||"")}${c.jurisdiction ? " · " + htmlEscape(c.jurisdiction) : ""}</span></div>
            <div class="hitmark">${highlight(snippet, query)}</div><br>
            <a href="${c.url_txt}" target="_blank" rel="noopener">open TXT</a>
          </div>
        `);
      }
      RESULTS.innerHTML = parts.join("\n");
    }

    function doSearch() {
      if (!firstReady) return;
      let q = Q.value.trim();
      if (!q) { RESULTS.innerHTML = '<div class="card">Enter a query.</div>'; return; }
      const run = OR.checked ? makeOrQuery(q) : q;
      const t0 = performance.now();
      const res = lunrIndex.search(run);
      const t1 = performance.now();
      render(res, q);
      DIAG.textContent = `Query: ${q} · OR=${OR.checked} · Hits=${res.length} · Chunks=${total} · ${Math.round(t1-t0)}ms`;
    }

    GO.addEventListener('click', doSearch);
    Q.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });

    load().catch(err => {
      console.error(err);
      RESULTS.textContent = "Failed to load index.";
      DIAG.textContent = String(err);
    });
  })();
  </script>
</body>
</html>
