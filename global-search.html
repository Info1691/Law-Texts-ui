<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trust Law Textbooks — Forensic Search</title>
  <link rel="icon" href="logo.png">
  <style>
    :root{
      --ink:#0f172a; --muted:#475569; --bg:#f8fafc; --card:#ffffff; --brand:#0b4d6d;
      --ring:rgba(2,132,199,.25);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{background:#0a3651;color:#fff;padding:16px 20px;display:flex;align-items:center;gap:12px}
    header img{width:28px;height:28px}
    header h1{margin:0;font-size:18px;font-weight:600}
    main{max-width:980px;margin:24px auto;padding:0 16px}
    .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    input[type="search"]{
      flex:1;min-width:280px;padding:12px 14px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;
      outline:none;box-shadow:0 1px 0 rgba(0,0,0,.02)
    }
    input[type="search"]:focus{border-color:#0284c7;box-shadow:0 0 0 4px var(--ring)}
    .hint{color:var(--muted);font-size:13px}
    .count{color:var(--muted);font-size:13px;margin-left:auto}
    .card{
      background:var(--card);border:1px solid #e2e8f0;border-radius:14px;padding:14px 16px;
      margin:12px 0;box-shadow:0 1px 2px rgba(0,0,0,.03)
    }
    .title{font-weight:600;margin:0 0 4px 0}
    .meta{color:var(--muted);font-size:13px;margin:0 0 8px 0}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{font-size:12px;border:1px solid #e2e8f0;border-radius:999px;padding:4px 8px;background:#f8fafc}
    .btn{
      appearance:none;border:0;border-radius:10px;background:var(--brand);color:#fff;
      padding:8px 12px;font-size:14px;cursor:pointer
    }
    .btn.secondary{background:#0a3651}
    .src{margin-top:24px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="BB">
    <h1>Forensic search (Agent 2)</h1>
  </header>

  <main>
    <div class="row">
      <input id="q" type="search" placeholder="Search titles, references, keywords (e.g., trustee producer film)…" autofocus />
      <div class="count" id="count"></div>
    </div>
    <p class="hint">Results are built from the Agent-2 index and open the canonical TXT for each book.</p>

    <div id="results"></div>

    <p class="src" id="src"></p>
  </main>

<script>
/* ---------- configuration: choose one URL ---------- */
const INDEX_URL =
  // Prefer GitHub Pages if enabled:
  // 'https://info1691.github.io/lex-jsy-forensics/dist/index.json';
  // Otherwise, raw content works too:
  'https://raw.githubusercontent.com/Info1691/lex-jsy-forensics/main/dist/index.json';
/* --------------------------------------------------- */

const $q = document.getElementById('q');
const $res = document.getElementById('results');
const $count = document.getElementById('count');
const $src = document.getElementById('src');

let INDEX = [];

function norm(s){ return String(s||'').toLowerCase(); }

function score(hit, terms){
  // naive scoring: +3 in title, +2 in reference, +1 per keyword match
  let s = 0;
  const t = norm(hit.title), r = norm(hit.reference);
  for(const term of terms){
    if(!term) continue;
    if(t.includes(term)) s += 3;
    if(r.includes(term)) s += 2;
    if(Array.isArray(hit.keywords)){
      for(const k of hit.keywords) if(norm(k).includes(term)) s += 1;
    }
  }
  return s;
}

function render(list){
  $res.innerHTML = '';
  $count.textContent = list.length ? `${list.length} result${list.length>1?'s':''}` : '0 results';
  for(const it of list){
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <p class="title">${it.title}</p>
      <p class="meta">${(it.jurisdiction||'').toUpperCase()} • ${it.year||''} • ${it.reference||''}</p>
      <div class="chips">${(it.keywords||[]).slice(0,12).map(k=>`<span class="chip">${k}</span>`).join('')}</div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn" href="${it.url_txt}" target="_blank" rel="noopener">Open TXT</a>
      </div>
    `;
    $res.appendChild(card);
  }
}

async function boot(){
  $src.textContent = `Source: ${INDEX_URL}`;
  try{
    const res = await fetch(INDEX_URL, {cache:'no-store'});
    const data = await res.json();
    INDEX = Array.isArray(data) ? data : [];
    render(INDEX);
  }catch(e){
    $res.innerHTML = `<div class="card"><p class="meta">Failed to load index: ${e.message}</p></div>`;
  }
}

$q.addEventListener('input', () => {
  const q = norm($q.value).trim();
  if(!q){ render(INDEX); return; }
  const terms = q.split(/\s+/).filter(Boolean);
  const hits = INDEX
    .map(item => ({ item, s: score(item, terms)}))
    .filter(x => x.s > 0)
    .sort((a,b)=>b.s-a.s)
    .map(x => x.item);
  render(hits);
});

boot();
</script>
</body>
</html>
